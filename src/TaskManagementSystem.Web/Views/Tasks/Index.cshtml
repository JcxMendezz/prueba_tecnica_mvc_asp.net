@model TaskManagementSystem.Web.Models.ViewModels.TaskListViewModel
@{
    ViewData["Title"] = "Mis Tareas";
}

<!-- Page Header -->
<div class="page-header">
    <div>
        <h1>Mis Tareas</h1>
        <p class="page-subtitle">Gestiona y organiza tus tareas de forma eficiente</p>
    </div>
    <a asp-action="Create" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i>
        Nueva Tarea
    </a>
</div>

<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card stat-pending">
        <div class="stat-icon">
            <i class="bi bi-clock"></i>
        </div>
        <div class="stat-value">@Model.PendingCount</div>
        <div class="stat-label">Pendientes</div>
    </div>
    <div class="stat-card stat-in-progress">
        <div class="stat-icon">
            <i class="bi bi-arrow-repeat"></i>
        </div>
        <div class="stat-value">@Model.InProgressCount</div>
        <div class="stat-label">En Progreso</div>
    </div>
    <div class="stat-card stat-completed">
        <div class="stat-icon">
            <i class="bi bi-check-circle"></i>
        </div>
        <div class="stat-value">@Model.CompletedCount</div>
        <div class="stat-label">Completadas</div>
    </div>
    <div class="stat-card stat-overdue">
        <div class="stat-icon">
            <i class="bi bi-exclamation-triangle"></i>
        </div>
        <div class="stat-value">@Model.OverdueCount</div>
        <div class="stat-label">Vencidas</div>
    </div>
</div>

<!-- Filters Section -->
<div class="filters-section">
    <form asp-action="Index" method="get" id="filterForm">
        <div class="filters-row">
            <!-- Search -->
            <div class="filter-group" style="flex: 2;">
                <label for="SearchTerm">Buscar</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text"
                           class="form-control border-start-0"
                           id="SearchTerm"
                           name="SearchTerm"
                           value="@Model.Filter.SearchTerm"
                           placeholder="Buscar por título o descripción..." />
                </div>
            </div>

            <!-- Status Filter -->
            <div class="filter-group">
                <label for="Status">Estado</label>
                <select class="form-select" id="Status" name="Status" onchange="this.form.submit()">
                    <option value="">Todos los estados</option>
                    <option value="@TaskItemStatus.Pending" selected="@(Model.Filter.Status == TaskItemStatus.Pending)">
                        Pendiente
                    </option>
                    <option value="@TaskItemStatus.InProgress" selected="@(Model.Filter.Status == TaskItemStatus.InProgress)">
                        En Progreso
                    </option>
                    <option value="@TaskItemStatus.Completed" selected="@(Model.Filter.Status == TaskItemStatus.Completed)">
                        Completada
                    </option>
                    <option value="@TaskItemStatus.Cancelled" selected="@(Model.Filter.Status == TaskItemStatus.Cancelled)">
                        Cancelada
                    </option>
                </select>
            </div>

            <!-- Priority Filter -->
            <div class="filter-group">
                <label for="Priority">Prioridad</label>
                <select class="form-select" id="Priority" name="Priority" onchange="this.form.submit()">
                    <option value="">Todas las prioridades</option>
                    <option value="@TaskPriority.Low" selected="@(Model.Filter.Priority == TaskPriority.Low)">
                        Baja
                    </option>
                    <option value="@TaskPriority.Medium" selected="@(Model.Filter.Priority == TaskPriority.Medium)">
                        Media
                    </option>
                    <option value="@TaskPriority.High" selected="@(Model.Filter.Priority == TaskPriority.High)">
                        Alta
                    </option>
                </select>
            </div>

            <!-- Sort -->
            <div class="filter-group">
                <label for="SortBy">Ordenar por</label>
                <select class="form-select" id="SortBy" name="SortBy" onchange="this.form.submit()">
                    <option value="DueDate" selected="@(Model.Filter.SortBy == "DueDate")">Fecha vencimiento</option>
                    <option value="CreatedAt" selected="@(Model.Filter.SortBy == "CreatedAt")">Fecha creación</option>
                    <option value="Title" selected="@(Model.Filter.SortBy == "Title")">Título</option>
                    <option value="Priority" selected="@(Model.Filter.SortBy == "Priority")">Prioridad</option>
                    <option value="Status" selected="@(Model.Filter.SortBy == "Status")">Estado</option>
                </select>
            </div>
                     <!-- Page Size -->
            <div class="filter-group" style="flex: 0 0 100px;">
                <label for="PageSize">Mostrar</label>
                <select class="form-select" id="PageSize" name="PageSize" onchange="this.form.submit()">
                    <option value="5" selected="@(Model.Filter.PageSize == 5)">5</option>
                    <option value="10" selected="@(Model.Filter.PageSize == 10)">10</option>
                    <option value="25" selected="@(Model.Filter.PageSize == 25)">25</option>
                    <option value="50" selected="@(Model.Filter.PageSize == 50)">50</option>
                </select>
            </div>

            <!-- Actions -->
            <div class="filter-group d-flex gap-2" style="flex: 0 0 auto;">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-funnel"></i>
                    Filtrar
                </button>
                @if (Model.Filter.HasActiveFilters)
                {
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-x-lg"></i>
                        Limpiar
                    </a>
                }
            </div>
        </div>

        <!-- Hidden fields -->
        <input type="hidden" name="SortDescending" value="@Model.Filter.SortDescending.ToString().ToLower()" />
        <input type="hidden" name="Page" value="1" />
        <input type="hidden" name="PageSize" value="@Model.Filter.PageSize" />

        <!-- Active Filters Tags -->
        @if (Model.Filter.HasActiveFilters)
        {
            <div class="active-filters">
                <span class="text-muted text-sm me-2">Filtros activos:</span>
                @if (Model.Filter.Status.HasValue)
                {
                    <span class="filter-tag">
                        <i class="bi bi-circle-fill"></i>
                        Estado: @(Model.Filter.Status switch {
                            TaskItemStatus.Pending => "Pendiente",
                            TaskItemStatus.InProgress => "En Progreso",
                            TaskItemStatus.Completed => "Completada",
                            TaskItemStatus.Cancelled => "Cancelada",
                            _ => "Todos"
                        })
                        <a asp-action="Index"
                           asp-route-Priority="@Model.Filter.Priority"
                           asp-route-SearchTerm="@Model.Filter.SearchTerm"
                           asp-route-SortBy="@Model.Filter.SortBy"
                           class="ms-1">&times;</a>
                    </span>
                }
                @if (Model.Filter.Priority.HasValue)
                {
                    <span class="filter-tag">
                        <i class="bi bi-flag"></i>
                        Prioridad: @(Model.Filter.Priority switch {
                            TaskPriority.Low => "Baja",
                            TaskPriority.Medium => "Media",
                            TaskPriority.High => "Alta",
                            _ => "Todas"
                        })
                        <a asp-action="Index"
                           asp-route-Status="@Model.Filter.Status"
                           asp-route-SearchTerm="@Model.Filter.SearchTerm"
                           asp-route-SortBy="@Model.Filter.SortBy"
                           class="ms-1">&times;</a>
                    </span>
                }
                @if (!string.IsNullOrWhiteSpace(Model.Filter.SearchTerm))
                {
                    <span class="filter-tag">
                        <i class="bi bi-search"></i>
                        "@Model.Filter.SearchTerm"
                        <a asp-action="Index"
                           asp-route-Status="@Model.Filter.Status"
                           asp-route-Priority="@Model.Filter.Priority"
                           asp-route-SortBy="@Model.Filter.SortBy"
                           class="ms-1">&times;</a>
                    </span>
                }
            </div>
        }
    </form>
</div>

<!-- Tasks Content -->
@if (Model.IsEmpty)
{
    <!-- Empty State -->
    <div class="card">
        <div class="card-body">
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-inbox"></i>
                </div>
                <h5 class="empty-title">No hay tareas</h5>
                <p class="empty-description">
                    @if (Model.Filter.HasActiveFilters)
                    {
                        <span>No se encontraron tareas con los filtros aplicados.</span>
                    }
                    else
                    {
                        <span>Comienza creando tu primera tarea para organizar tu trabajo.</span>
                    }
                </p>
                @if (Model.Filter.HasActiveFilters)
                {
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-x-lg"></i>
                        Limpiar filtros
                    </a>
                }
                else
                {
                    <a asp-action="Create" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i>
                        Crear primera tarea
                    </a>
                }
            </div>
        </div>
    </div>
}
else
{
    <!-- Task Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table-elegant">
                <thead>
                    <tr>
                        <th style="width: 40%;">
                            <a asp-action="Index"
                               asp-route-Status="@Model.Filter.Status"
                               asp-route-Priority="@Model.Filter.Priority"
                               asp-route-SearchTerm="@Model.Filter.SearchTerm"
                               asp-route-SortBy="Title"
                               asp-route-SortDescending="@(Model.Filter.SortBy == "Title" ? (!Model.Filter.SortDescending).ToString().ToLower() : "false")"
                               class="text-decoration-none text-reset d-flex align-items-center gap-1">
                                Tarea
                                @if (Model.Filter.SortBy == "Title")
                                {
                                    <i class="bi bi-chevron-@(Model.Filter.SortDescending ? "down" : "up") text-primary"></i>
                                }
                            </a>
                        </th>
                        <th style="width: 12%;">
                            <a asp-action="Index"
                               asp-route-Status="@Model.Filter.Status"
                               asp-route-Priority="@Model.Filter.Priority"
                               asp-route-SearchTerm="@Model.Filter.SearchTerm"
                               asp-route-SortBy="Status"
                               asp-route-SortDescending="@(Model.Filter.SortBy == "Status" ? (!Model.Filter.SortDescending).ToString().ToLower() : "false")"
                               class="text-decoration-none text-reset d-flex align-items-center gap-1">
                                Estado
                                @if (Model.Filter.SortBy == "Status")
                                {
                                    <i class="bi bi-chevron-@(Model.Filter.SortDescending ? "down" : "up") text-primary"></i>
                                }
                            </a>
                        </th>
                        <th style="width: 12%;">
                            <a asp-action="Index"
                               asp-route-Status="@Model.Filter.Status"
                               asp-route-Priority="@Model.Filter.Priority"
                               asp-route-SearchTerm="@Model.Filter.SearchTerm"
                               asp-route-SortBy="Priority"
                               asp-route-SortDescending="@(Model.Filter.SortBy == "Priority" ? (!Model.Filter.SortDescending).ToString().ToLower() : "false")"
                               class="text-decoration-none text-reset d-flex align-items-center gap-1">
                                Prioridad
                                @if (Model.Filter.SortBy == "Priority")
                                {
                                    <i class="bi bi-chevron-@(Model.Filter.SortDescending ? "down" : "up") text-primary"></i>
                                }
                            </a>
                        </th>
                        <th style="width: 18%;">
                            <a asp-action="Index"
                               asp-route-Status="@Model.Filter.Status"
                               asp-route-Priority="@Model.Filter.Priority"
                               asp-route-SearchTerm="@Model.Filter.SearchTerm"
                               asp-route-SortBy="DueDate"
                               asp-route-SortDescending="@(Model.Filter.SortBy == "DueDate" ? (!Model.Filter.SortDescending).ToString().ToLower() : "false")"
                               class="text-decoration-none text-reset d-flex align-items-center gap-1">
                                Vencimiento
                                @if (Model.Filter.SortBy == "DueDate")
                                {
                                    <i class="bi bi-chevron-@(Model.Filter.SortDescending ? "down" : "up") text-primary"></i>
                                }
                            </a>
                        </th>
                        <th style="width: 18%;" class="text-end">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var task in Model.Tasks)
                    {
                        <tr class="@task.RowClass">
                            <td>
                                <div class="d-flex align-items-start gap-3">
                                    <div class="task-checkbox">
                                        @if (task.IsCompleted)
                                        {
                                            <i class="bi bi-check-circle-fill text-success fs-5"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-circle text-muted fs-5"></i>
                                        }
                                    </div>
                                    <div class="task-info">
                                        <a asp-action="Details" asp-route-id="@task.Id"
                                           class="task-title-link @(task.IsCompleted ? "completed" : "")">
                                            @task.Title
                                        </a>
                                        @if (!string.IsNullOrEmpty(task.Description))
                                        {
                                            <p class="task-description mb-0">@task.ShortDescription</p>
                                        }
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge-elegant @task.StatusBadgeClass">
                                    <i class="bi @task.StatusIcon"></i>
                                    @task.StatusText
                                </span>
                            </td>
                            <td>
                                <span class="badge-elegant @task.PriorityBadgeClass">
                                    <i class="bi @task.PriorityIcon"></i>
                                    @task.PriorityText
                                </span>
                            </td>
                            <td>
                                <div class="due-date @(task.IsOverdue ? "overdue" : "")">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    <span>@task.DueDateRelative</span>
                                </div>
                            </td>
                            <td>
                                <div class="task-actions justify-content-end">
                                    <a asp-action="Details" asp-route-id="@task.Id"
                                       class="btn btn-ghost btn-icon btn-sm"
                                       data-bs-toggle="tooltip" title="Ver detalles">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a asp-action="Edit" asp-route-id="@task.Id"
                                       class="btn btn-ghost btn-icon btn-sm"
                                       data-bs-toggle="tooltip" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a asp-action="Delete" asp-route-id="@task.Id"
                                       class="btn btn-ghost btn-icon btn-sm text-danger"
                                       data-bs-toggle="tooltip" title="Eliminar">
                                        <i class="bi bi-trash3"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="card-footer d-flex justify-content-between align-items-center">
                <div class="pagination-info text-muted text-sm">
                    Mostrando <strong>@Model.StartItem</strong> - <strong>@Model.EndItem</strong> de <strong>@Model.FilteredCount</strong> tareas
                </div>
                <nav aria-label="Paginación de tareas">
                    <ul class="pagination pagination-sm mb-0">
                        <!-- Previous -->
                        <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                            <a class="page-link"
                               asp-action="Index"
                               asp-route-Status="@Model.Filter.Status"
                               asp-route-Priority="@Model.Filter.Priority"
                               asp-route-SearchTerm="@Model.Filter.SearchTerm"
                               asp-route-SortBy="@Model.Filter.SortBy"
                               asp-route-SortDescending="@Model.Filter.SortDescending.ToString().ToLower()"
                               asp-route-Page="@(Model.CurrentPage - 1)"
                               asp-route-PageSize="@Model.PageSize">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>

                        <!-- Page Numbers -->
                        @{
                            var startPage = Math.Max(1, Model.CurrentPage - 2);
                            var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                        }

                        @if (startPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link"
                                   asp-action="Index"
                                   asp-route-Status="@Model.Filter.Status"
                                   asp-route-Priority="@Model.Filter.Priority"
                                   asp-route-SearchTerm="@Model.Filter.SearchTerm"
                                   asp-route-SortBy="@Model.Filter.SortBy"
                                   asp-route-SortDescending="@Model.Filter.SortDescending.ToString().ToLower()"
                                   asp-route-Page="1"
                                   asp-route-PageSize="@Model.PageSize">1</a>
                            </li>
                            @if (startPage > 2)
                            {
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            }
                        }

                        @for (var i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link"
                                   asp-action="Index"
                                   asp-route-Status="@Model.Filter.Status"
                                   asp-route-Priority="@Model.Filter.Priority"
                                   asp-route-SearchTerm="@Model.Filter.SearchTerm"
                                   asp-route-SortBy="@Model.Filter.SortBy"
                                   asp-route-SortDescending="@Model.Filter.SortDescending.ToString().ToLower()"
                                   asp-route-Page="@i"
                                   asp-route-PageSize="@Model.PageSize">@i</a>
                            </li>
                        }

                        @if (endPage < Model.TotalPages)
                        {
                            @if (endPage < Model.TotalPages - 1)
                            {
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            }
                            <li class="page-item">
                                <a class="page-link"
                                   asp-action="Index"
                                   asp-route-Status="@Model.Filter.Status"
                                   asp-route-Priority="@Model.Filter.Priority"
                                   asp-route-SearchTerm="@Model.Filter.SearchTerm"
                                   asp-route-SortBy="@Model.Filter.SortBy"
                                   asp-route-SortDescending="@Model.Filter.SortDescending.ToString().ToLower()"
                                   asp-route-Page="@Model.TotalPages"
                                   asp-route-PageSize="@Model.PageSize">@Model.TotalPages</a>
                            </li>
                        }

                        <!-- Next -->
                        <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                            <a class="page-link"
                               asp-action="Index"
                               asp-route-Status="@Model.Filter.Status"
                               asp-route-Priority="@Model.Filter.Priority"
                               asp-route-SearchTerm="@Model.Filter.SearchTerm"
                               asp-route-SortBy="@Model.Filter.SortBy"
                               asp-route-SortDescending="@Model.Filter.SortDescending.ToString().ToLower()"
                               asp-route-Page="@(Model.CurrentPage + 1)"
                               asp-route-PageSize="@Model.PageSize">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
        else if (Model.HasTasks)
        {
            <div class="card-footer">
                <div class="text-muted text-sm">
                    Mostrando <strong>@Model.FilteredCount</strong> tareas
                </div>
            </div>
        }
    </div>
}

@section Scripts {
    <script src="~/js/tasks/task-list.js" asp-append-version="true"></script>
}
